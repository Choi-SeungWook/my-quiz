<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ì˜ì–´ ë¬¸ì¥ í€´ì¦ˆ Pro +</title>
    <style>
        /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€ ë° ì¼ë¶€ ì¶”ê°€ */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            text-align: center; padding: 0; margin: 0; 
            background-color: #121212; color: #e0e0e0; 
            height: 100vh; display: flex; flex-direction: column;
            user-select: none; -webkit-tap-highlight-color: transparent; overflow: hidden; 
        }
        #timer-display {
            position: fixed; top: env(safe-area-inset-top, 20px); left: 50%; transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.1); color: #ffffff; padding: 8px 18px;
            border-radius: 20px; font-weight: bold; font-size: 1rem; z-index: 1000;
            backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.2);
        }
        #setup, .quiz-container { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 90%; max-width: 500px; display: flex; flex-direction: column; align-items: center; 
        }
        .setup-card {
            background: #1e1e1e; width: 100%; padding: 30px 20px; border-radius: 20px;
            box-shadow: 0 4px 25px rgba(0,0,0,0.5); box-sizing: border-box; border: 1px solid #333;
        }
        .option-group { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; margin: 15px 0; background: #252525; padding: 15px; border-radius: 12px; }
        .option-item { display: flex; align-items: center; cursor: pointer; font-size: 1rem; font-weight: 500; color: #ccc; }
        .option-item input { width: 18px; height: 18px; margin-right: 8px; filter: invert(1); }
        input[type="text"] { padding: 15px; width: 80%; font-size: 1.1rem; border: 2px solid #444; background-color: #2c2c2c; color: #fff; border-radius: 12px; margin-bottom: 10px; outline: none; text-align: center; }
        .info-progress { font-size: 0.9rem; color: #999; margin-bottom: 15px; }
        .card { background: #1e1e1e; width: 100%; padding: 50px 25px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.4); position: relative; box-sizing: border-box; cursor: pointer; border: 1px solid #333; min-height: 250px; display: flex; flex-direction: column; justify-content: center; }
        .kor-text { font-size: 1.5rem; font-weight: bold; color: #ffffff; margin-bottom: 25px; line-height: 1.4; word-break: keep-all; }
        .eng-text { font-size: 1.4rem; color: #4ade80; font-weight: 600; min-height: 1.5em; }
        .hint-msg { color: #666; font-size: 0.85rem; margin-top: 30px; }
        .controls { width: 100%; margin-top: 20px; display: flex; flex-direction: column; gap: 15px; }
        .nav-btns { display: flex; gap: 10px; width: 100%; }
        .btn { border: none; border-radius: 15px; font-weight: bold; cursor: pointer; transition: 0.2s; font-size: 1.1rem; }
        .start-btn { padding: 16px; background: #0062cc; color: white; width: 100%; margin-top: 10px; }
        .review-start-btn { padding: 16px; background: #8e44ad; color: white; width: 100%; margin-top: 10px; }
        .review-start-btn:disabled { background: #333; color: #666; cursor: not-allowed; }
        .sync-btn { flex: 1; padding: 10px; background: #2c3e50; color: #bdc3c7; font-size: 0.8rem; border-radius: 10px; border:none; }
        .nav-btn { flex: 1; padding: 12px; background: #333; color: white; font-size: 0.9rem; }
        .nav-btn:disabled { opacity: 0.3; cursor: not-allowed; }
        .dont-know-btn { padding: 12px; background: transparent; color: #ff6b6b; border: 2px solid #ff6b6b; font-size: 0.9rem; width: 100%; }
        .dont-know-btn.active { background: #ff6b6b; color: #fff; }
        h2 { color: #fff; margin-bottom: 10px; }
    </style>
</head>
<body>

    <div id="timer-display" style="display:none;">00:00</div>

    <div id="setup">
        <div class="setup-card">
            <h2>ğŸ¯ ì˜ì–´ í€´ì¦ˆ ì„¤ì •</h2>
            <p id="total-info" style="color:#ff6b6b; font-size: 0.9rem; font-weight: bold; margin-bottom: 15px;">ë°ì´í„° ë¡œë“œ ëŒ€ê¸° ì¤‘...</p>
            <input type="text" id="page-input" placeholder="ì¥ ë²ˆí˜¸ (ì˜ˆ: 1, 3-5)" onkeydown="if(event.key==='Enter') startQuiz('normal')">
            
            <div class="option-group">
                <label class="option-item"><input type="radio" name="order" value="seq" checked> ìˆœì°¨</label>
                <label class="option-item"><input type="radio" name="order" value="rand"> ëœë¤</label>
            </div>

            <div class="option-group">
                <label class="option-item"><input type="checkbox" id="auto-mode"> âš¡ ê¹œë¹¡ì´ ëª¨ë“œ (2ì´ˆ)</label>
                <label class="option-item"><input type="checkbox" id="tts-mode"> ğŸ”Š ìŒì„± ì§€ì›</label>
            </div>

            <button class="btn start-btn" onclick="startQuiz('normal')">í•™ìŠµ ì‹œì‘í•˜ê¸°</button>
            <button id="review-btn" class="btn review-start-btn" onclick="startQuiz('review')">âŒ ëª¨ë¥´ëŠ” ë¬¸ì¥ ë³µìŠµ (0)</button>
            <div style="display:flex; gap:10px; margin-top:15px; width:100%;">
                <button class="sync-btn" onclick="syncToGithub()">ğŸ“¤ ë‚´ë³´ë‚´ê¸°</button>
                <button class="sync-btn" onclick="fetchFromGithub()">ğŸ“¥ ê°€ì ¸ì˜¤ê¸°</button>
            </div>
        </div>
    </div>

    <div id="quiz" class="quiz-container" style="display:none;">
        <div class="info-progress" id="progress"></div>
        <div class="card" id="quiz-card" onclick="handleMainAction()">
            <div class="kor-text" id="kor-text"></div>
            <div class="eng-text" id="eng-text" style="visibility: hidden;"></div>
            <div class="hint-msg" id="hint-msg">í„°ì¹˜/ì—”í„°: ì •ë‹µ ë³´ê¸°</div>
        </div>
        <div class="controls">
            <button id="fail-btn" class="btn dont-know-btn" onclick="toggleFailedList(event)">ì´ ë¬¸ì¥ ì˜ ëª°ë¼ìš” (ì²´í¬)</button>
            <div class="nav-btns">
                <button id="prev-btn" class="btn nav-btn" onclick="moveQuestion(-1)">â—€ ì´ì „</button>
                <button id="next-btn" class="btn nav-btn" onclick="moveQuestion(1)">ë‹¤ìŒ â–¶</button>
            </div>
        </div>
    </div>

    <script>
        const OWNER = 'Choi-SeungWook'; 
        const REPO = 'my-quiz';      
        const DATA_FILE = 'English_Sentences.txt';
        const STORAGE_KEY = 'failed_sentences';
        const FILE_PATH = 'failed_list.json';

        let allData = [], quizList = [], currentIndex = 0;
        let isShowingAnswer = false, startTime, timerInterval, autoTimer;
        
        // ì„¤ì • ê°’
        let config = { auto: false, tts: false };

        fetch(DATA_FILE).then(res => res.text()).then(text => {
            text.split(/\r?\n/).forEach(line => {
                let clean = line.trim();
                if (!clean) return;
                if (clean.includes(']')) clean = clean.split(']').pop().trim();
                const parts = clean.split(',');
                if (parts.length >= 3) {
                    const num = parseInt(parts[0].trim());
                    if (!isNaN(num)) allData.push({ num, kor: parts[1].trim(), eng: parts[2].trim() });
                }
            });
            if (allData.length > 0) {
                document.getElementById('total-info').innerText = `âœ… ì´ ${allData.length}ë¬¸ì¥ ë¡œë“œ ì™„ë£Œ`;
                document.getElementById('total-info').style.color = "#4ade80";
                updateReviewButtonCount();
            }
        });

        function getFailedIDs() { return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"); }
        function updateReviewButtonCount() {
            const count = getFailedIDs().length;
            const btn = document.getElementById('review-btn');
            btn.innerText = `âŒ ëª¨ë¥´ëŠ” ë¬¸ì¥ ë³µìŠµ (${count})`;
            btn.disabled = count === 0;
        }

        // ìŒì„± ì¶œë ¥ í•¨ìˆ˜
        function speak(text, lang) {
            if (!config.tts) return;
            window.speechSynthesis.cancel(); // ì´ì „ ìŒì„± ì¤‘ë‹¨
            const msg = new SpeechSynthesisUtterance(text);
            msg.lang = lang; // 'en-US' ë˜ëŠ” 'ko-KR'
            msg.rate = 1.0;
            window.speechSynthesis.speak(msg);
        }

        function handleMainAction() {
            if (config.auto) return; // ìë™ëª¨ë“œì¼ ë• í´ë¦­ ë¬´ì‹œ (ì›í•˜ë©´ ì¤‘ë‹¨ ë¡œì§ ì¶”ê°€ ê°€ëŠ¥)
            
            if (!isShowingAnswer) {
                showAnswer();
            } else {
                moveQuestion(1);
            }
        }

        function showAnswer() {
            isShowingAnswer = true;
            document.getElementById('eng-text').style.visibility = 'visible';
            document.getElementById('hint-msg').innerText = config.auto ? 'ìë™ ì¬ìƒ ì¤‘...' : 'í„°ì¹˜/ì—”í„°: ë‹¤ìŒ ë¬¸ì œ';
            
            const q = quizList[currentIndex];
            if (config.tts) speak(q.eng, 'en-US');

            if (config.auto) {
                autoTimer = setTimeout(() => moveQuestion(1), 2000);
            }
        }

        function moveQuestion(step) {
            clearTimeout(autoTimer);
            const nextIdx = currentIndex + step;
            if (nextIdx < 0) return;
            if (nextIdx >= quizList.length) {
                finishQuiz();
                return;
            }
            currentIndex = nextIdx;
            isShowingAnswer = false;
            showQuestion();
        }

        function showQuestion() {
            const q = quizList[currentIndex];
            document.getElementById('progress').innerText = `${currentIndex + 1} / ${quizList.length}`;
            document.getElementById('kor-text').innerText = q.kor;
            document.getElementById('eng-text').innerText = q.eng;
            document.getElementById('eng-text').style.visibility = 'hidden';
            document.getElementById('hint-msg').innerText = config.auto ? 'ìë™ ì¬ìƒ ì¤‘...' : 'í„°ì¹˜/ì—”í„°: ì •ë‹µ ë³´ê¸°';
            document.getElementById('prev-btn').disabled = currentIndex === 0;
            document.getElementById('next-btn').innerText = (currentIndex === quizList.length - 1) ? "í•™ìŠµ ì™„ë£Œ ğŸ" : "ë‹¤ìŒ â–¶";
            
            renderQuestionState();

            // TTSê°€ ì¼œì ¸ìˆìœ¼ë©´ í•œê¸€ ë¨¼ì € ì½ê¸°
            if (config.tts) speak(q.kor, 'ko-KR');

            // ìë™ ëª¨ë“œë©´ 2ì´ˆ í›„ ì •ë‹µ ê³µê°œ
            if (config.auto) {
                autoTimer = setTimeout(() => showAnswer(), 2000);
            }
        }

        function startQuiz(mode) {
            const order = document.querySelector('input[name="order"]:checked').value;
            config.auto = document.getElementById('auto-mode').checked;
            config.tts = document.getElementById('tts-mode').checked;

            if (mode === 'normal') {
                const val = document.getElementById('page-input').value.trim();
                if (!val) return alert("ì¥ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
                const pages = new Set();
                val.split(',').forEach(p => {
                    if (p.includes('-')) {
                        const [s, e] = p.split('-').map(Number);
                        for (let i = Math.min(s,e); i <= Math.max(s,e); i++) pages.add(i);
                    } else pages.add(parseInt(p));
                });
                quizList = allData.filter(d => pages.has(Math.ceil(d.num / 30)));
            } else {
                const ids = getFailedIDs();
                quizList = allData.filter(d => ids.includes(d.num));
            }

            if (quizList.length === 0) return alert("í•´ë‹¹í•˜ëŠ” ë¬¸ì¥ì´ ì—†ìŠµë‹ˆë‹¤.");
            
            quizList.sort((a,b) => order === 'rand' ? Math.random() - 0.5 : a.num - b.num);
            currentIndex = 0;
            isShowingAnswer = false;

            document.getElementById('setup').style.display = 'none';
            document.getElementById('quiz').style.display = 'flex';
            document.getElementById('timer-display').style.display = 'block';
            
            startTime = Date.now();
            timerInterval = setInterval(updateTimer, 1000);
            
            showQuestion();
        }

        function updateTimer() {
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            document.getElementById('timer-display').innerText = `${String(Math.floor(elapsed/60)).padStart(2,'0')}:${String(elapsed%60).padStart(2,'0')}`;
        }

        function finishQuiz() {
            clearInterval(timerInterval);
            clearTimeout(autoTimer);
            alert(`ğŸ‰ í•™ìŠµ ì™„ë£Œ! ì†Œìš” ì‹œê°„: ${document.getElementById('timer-display').innerText}`);
            location.reload();
        }

        function toggleFailedList(event) {
            if (event) event.stopPropagation();
            const q = quizList[currentIndex];
            let ids = getFailedIDs();
            if (!ids.includes(q.num)) ids.push(q.num);
            else ids = ids.filter(id => id !== q.num);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(ids));
            updateReviewButtonCount();
            renderQuestionState();
        }

        function renderQuestionState() {
            const fBtn = document.getElementById('fail-btn');
            if (getFailedIDs().includes(quizList[currentIndex].num)) {
                fBtn.classList.add('active');
                fBtn.innerText = "âœ“ ì²´í¬ë¨ (ì˜êµ¬ ì €ì¥)";
            } else {
                fBtn.classList.remove('active');
                fBtn.innerText = "ì´ ë¬¸ì¥ ì˜ ëª°ë¼ìš” (ì²´í¬)";
            }
        }

        /* --- GitHub Sync functions (ê¸°ì¡´ê³¼ ë™ì¼) --- */
        async function syncToGithub() {
            const ids = getFailedIDs();
            const token = prompt("GitHub Token:");
            if (!token) return;
            const url = `https://api.github.com/repos/${OWNER}/${REPO}/contents/${FILE_PATH}`;
            try {
                const res = await fetch(url, { headers: { "Authorization": `token ${token}` } });
                const sha = res.ok ? (await res.json()).sha : null;
                const putRes = await fetch(url, {
                    method: "PUT",
                    headers: { "Authorization": `token ${token}`, "Content-Type": "application/json" },
                    body: JSON.stringify({ message: "Sync", content: btoa(unescape(encodeURIComponent(JSON.stringify(ids)))), sha })
                });
                if (putRes.ok) alert("âœ… ì„œë²„ ì €ì¥ ì™„ë£Œ");
            } catch (e) { alert("ì˜¤ë¥˜: " + e.message); }
        }

        async function fetchFromGithub() {
            const token = prompt("GitHub Token:");
            if (!token) return;
            try {
                const res = await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/contents/${FILE_PATH}`, { headers: { "Authorization": `token ${token}` } });
                if (res.ok) {
                    const ids = JSON.parse(decodeURIComponent(escape(atob((await res.json()).content))));
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(ids));
                    updateReviewButtonCount();
                    alert("âœ… ë°ì´í„°ë¥¼ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤");
                }
            } catch (e) { alert("ì˜¤ë¥˜: " + e.message); }
        }

        document.addEventListener('keydown', (e) => {
            if (document.getElementById('quiz').style.display === 'flex') {
                if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); handleMainAction(); }
                else if (e.key === 'ArrowLeft') moveQuestion(-1);
                else if (e.key === 'ArrowRight') moveQuestion(1);
                else if (e.key.toLowerCase() === 'm') toggleFailedList();
            }
        });
    </script>
</body>
</html>
